<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Interface</title>
    <style>
        body {
            background-color: #1e1e1e;
            font-family: Arial, sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .chat-container {
            width: 1024px; /* Fixed width for the chat container */
            height: 600px; /* Fixed height for the chat container */
            background-color: #2c2c2c;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .chatbox {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* Enable vertical scrolling */
            font-size: 14px;
            max-height: 100%;
        }

        /* Individual message styling */
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
            clear: both;
        }

        .user-message {
            background-color: #DCF8C6;
            color: #333;
            float: right;
            margin-right: 10px;
            padding: 10px;
        }

        .bot-message {
            text-align: left;
            margin-left: 10px;
            padding: 10px;
        }

        /* Input and Controls Styling */
        .input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #444;
            background-color: #333;
        }

        .model-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #444;
            background-color: #333;
        }

        /* Side Panel Styling */
        .side-panel {
            width: 250px;
            height: 600px;
            background-color: #2c2c2c;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            border-right: 1px solid #444;
        }

        .side-panel h2 {
            margin-top: 0;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .conversation-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .conversation-item {
            padding: 10px;
            background-color: #3a3a3a;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .conversation-item:hover {
            background-color: #505050;
        }

        .conversation-item.active {
            background-color: #555;
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: none;
            border-radius: 4px;
            background-color: #555;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .new-chat-btn:hover {
            background-color: #666;
        }

        /* Chat Container Styling */
        #entry {
            flex-grow: 1;
            padding: 10px;
            border-radius: 4px;
            border: none;
            outline: none;
            background-color: #444;
            color: white;
            font-size: 16px;
        }
    
        #send-btn, #load-btn, #clear-btn, #new-chat-btn, #stop-btn {
            margin-left: 10px;
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            background-color: #555;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #send-btn:hover, #load-btn:hover, #new-chat-btn:hover, #clear-btn:hover {
            background-color: #666;
        }

        #model-loader label {
            color: #fff; /* Set text color to white to match the chatbox theme */
            font-size: 12px; /* Slightly reduce font size */
            margin-right: 10px; /* Space between label and dropdown */
            font-weight: normal; /* Make the label less bold */
        }
        
        #knowledge-module {
            background-color: #2b2b2b; /* Darker background for the dropdown */
            color: #fff; /* White text color */
            border: 1px solid #555; /* Subtle border color */
            padding: 4px; /* Less padding for a compact look */
            border-radius: 4px; /* Rounded corners */
            width: 150px;
        }
        
        #model-loader {
            display: flex;
            align-items: center; /* Align label and dropdown vertically */
            margin: 10px 0; /* Space around the knowledge module section */
        }

        #stop-btn:hover {
            background-color: #e31e0e;
        }

        #send-btn:hover, #load-btn:hover {
            background-color: #666;
        }
    
        #model-entry {
            flex-grow: 1;
            padding: 10px;
            border-radius: 4px;
            border: none;
            outline: none;
            background-color: #444;
            color: white;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="side-panel">
        <button id="new-chat-btn" class="new-chat-btn">New Chat</button>
        <h2>Conversations</h2>
        <ul id="conversation-list" class="conversation-list">
            <!-- Conversation items will be appended here -->
        </ul>
    </div>
    <div class="chat-container">
        <div id="chatbox" class="chatbox"></div>
        <div id="chatlog"></div>

        <!-- Load Model Section --> 
        <div class="input-container">
            <input type="text" id="entry" placeholder="Type a message..." autocomplete="off">
            <div class="model-container">
                <select id="knowledge-module">
                    <option value="None">None</option>
                    <option value="global_facts">Global Facts</option>
                    <option value="high_school_microeconomics">High School Microeconomics</option>
                    <option value="professional_law">Professional Law</option>
                    <option value="elementary_mathematics">Elementary Mathematics</option>
                    <option value="professional_psychology">Professional Psychology</option>
                    <option value="medical_genetics">Medical Genetics</option>
                    <option value="high_school_biology">High School Biology</option>
                    <option value="computer_security">Computer Security</option>
                    <option value="astronomy">Astronomy</option>
                    <option value="college_biology">College Biology</option>
                    <option value="high_school_government_and_politics">High School Government and Politics</option>
                    <option value="high_school_physics">High School Physics</option>
                    <option value="high_school_us_history">High School US History</option>
                    <option value="high_school_psychology">High School Psychology</option>
                    <option value="philosophy">Philosophy</option>
                    <option value="formal_logic">Formal Logic</option>
                    <option value="nutrition">Nutrition</option>
                    <option value="high_school_geography">High School Geography</option>
                    <option value="machine_learning">Machine Learning</option>
                    <option value="professional_accounting">Professional Accounting</option>
                    <option value="professional_medicine">Professional Medicine</option>
                    <option value="electrical_engineering">Electrical Engineering</option>
                    <option value="prehistory">Prehistory</option>
                    <option value="clinical_knowledge">Clinical Knowledge</option>
                    <option value="marketing">Marketing</option>
                    <option value="security_studies">Security Studies</option>
                    <option value="world_religions">World Religions</option>
                    <option value="business_ethics">Business Ethics</option>
                    <option value="high_school_macroeconomics">High School Macroeconomics</option>
                    <option value="international_law">International Law</option>
                    <option value="high_school_chemistry">High School Chemistry</option>
                    <option value="anatomy">Anatomy</option>
                    <option value="college_mathematics">College Mathematics</option>
                    <option value="sociology">Sociology</option>
                    <option value="high_school_statistics">High School Statistics</option>
                    <option value="moral_scenarios">Moral Scenarios</option>
                    <option value="college_computer_science">College Computer Science</option>
                    <option value="high_school_european_history">High School European History</option>
                    <option value="us_foreign_policy">US Foreign Policy</option>
                    <option value="human_sexuality">Human Sexuality</option>
                    <option value="high_school_mathematics">High School Mathematics</option>
                    <option value="public_relations">Public Relations</option>
                    <option value="management">Management</option>
                    <option value="high_school_computer_science">High School Computer Science</option>
                    <option value="logical_fallacies">Logical Fallacies</option>
                    <option value="conceptual_physics">Conceptual Physics</option>
                    <option value="jurisprudence">Jurisprudence</option>
                    <option value="moral_disputes">Moral Disputes</option>
                    <option value="college_physics">College Physics</option>
                    <option value="human_aging">Human Aging</option>
                    <option value="college_medicine">College Medicine</option>
                    <option value="college_chemistry">College Chemistry</option>
                    <option value="abstract_algebra">Abstract Algebra</option>
                    <option value="econometrics">Econometrics</option>
                    <option value="high_school_world_history">High School World History</option>
                    <option value="miscellaneous">Miscellaneous</option>
                </select>
            </div>
            <button id="send-btn">Send</button>
            <button id="stop-btn" disabled>Stop</button>
            <button id="clear-btn">Clear</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked@14.1.2/lib/marked.umd.min.js"></script>
    <script>
        let stopRequested = false;  // Variable to track if stop is requested

        function generateUniqueId() {
            return 'xxxxxx'.replace(/[x]/g, () => 
                ((Math.random() * 16) | 0).toString(16)
            );
        }

        // Conversations Data Structure
        let currentConversationId = null;
        let conversationCount = 0;

        const conversationList = document.getElementById('conversation-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatbox = document.getElementById('chatbox');
        const entry = document.getElementById('entry');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const clearBtn = document.getElementById('clear-btn');
        const knowledgeModule = document.getElementById('knowledge-module');

        // Event listener for pressing Enter in the input field
        entry.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent the default action (submitting form, etc.)
                sendBtn.click(); // Programmatically click the send button
            }
        });

        // Function to create a new conversation
        function createNewConversation() {
            conversationCount += 1;
            const conversationId = generateUniqueId();
            const conversationName = `Conversation ${conversationCount}`;
            addConversationToList(conversationId, conversationName);
            switchConversation(conversationId);
        }

        // Function to add conversation to the side panel list
        function addConversationToList(conversationId, conversationName) {
            const li = document.createElement('li');
            li.className = 'conversation-item';
            li.id = `conv-${conversationId}`;
            li.textContent = conversationName;
            li.onclick = () => switchConversation(conversationId);
            conversationList.appendChild(li);
        }

        // Function to switch between conversations
        function switchConversation(conversationId) {
            // Update active class
            const items = document.querySelectorAll('.conversation-item');
            items.forEach(item => {
                if (item.id === `conv-${conversationId}`) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            currentConversationId = conversationId;
            renderConversation();
        }

        // Function to render the current conversation
        function renderConversation() {
            chatbox.innerHTML = ''; // Clear chatbox

            fetch('/get_conversation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    conversation_id: currentConversationId
                }),
            })
            .then(response => response.json())
            .then(data => {
                data.messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    chatbox.appendChild(msgDiv);
                    msgDiv.className = `message ${msg.role === 'user' ? 'user-message' : 'bot-message'}`;
                    msgDiv.innerHTML = `${msg.role === 'user' ? msg.content : marked.marked(msg.content)}`;
                });
                chatbox.scrollTop = chatbox.scrollHeight;
            })
        }

        // Initialize with one conversation
        createNewConversation();

        // New Chat Button Event
        newChatBtn.onclick = function() {
            createNewConversation();
        };

        document.getElementById('knowledge-module').onchange = function() {
            const selectedModule = document.getElementById('knowledge-module').value;

            // Send the selected knowledge module to the backend to load the appropriate model
            fetch('/load_knowledge_module', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    module_name: selectedModule,
                    conversation_id: currentConversationId
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert(`Model ${selectedModule} loaded successfully!`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        };

        document.getElementById('send-btn').onclick = function() {
            const chatlog = document.querySelector("#chat-log");
            const entry = document.getElementById('entry');
            const message = entry.value;

            if (message) {
                // Display the user's message
                const chatbox = document.getElementById('chatbox');
                chatbox.innerHTML += `<div class="message user-message">${message}</div>`;
                chatbox.scrollTop = chatbox.scrollHeight;
                entry.value = '';

                // Disable send button and enable stop button
                document.getElementById('send-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;

                // Reset stop request flag
                stopRequested = false;

                // Send the message to the server and handle streaming response
                fetch('/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversation_id: currentConversationId,
                        message: message
                    }),
                })
                .then(response => {
                    const reader = response.body.getReader();
                    let decoder = new TextDecoder();

                    let message = "";
                    let botMessageElement = document.createElement('div');
                    botMessageElement.className = 'message bot-message';
                    botMessageElement.innerHTML = "";
                    chatbox.appendChild(botMessageElement);

                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done || stopRequested) {
                                // Enable send button and disable stop button
                                document.getElementById('send-btn').disabled = false;
                                document.getElementById('stop-btn').disabled = true;
                                return;
                            }
                            let chunk = decoder.decode(value, { stream: true });

                            message += chunk;
                            botMessageElement.innerHTML = marked.marked(message);

                            // Scroll to the bottom of the chatbox
                            chatbox.scrollTop = chatbox.scrollHeight;
                            read();
                        });
                    }
                    read();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        };

        // Stop button functionality
        document.getElementById('clear-btn').onclick = function() {
            fetch('/clear_conversation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({conversation_id: currentConversationId})
            })
            .then(response => {
                renderConversation();
            })
        };

        // Stop button functionality
        document.getElementById('stop-btn').onclick = function() {
            stopRequested = true;  // Set the flag to request stop
        };
    </script>
</body>
</html>